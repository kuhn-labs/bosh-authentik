<%
  # Determine PostgreSQL configuration from link or properties
  if_link('database') do |db|
    pg_host = db.instances.first.address
    pg_port = db.p('port', 5432)
    pg_user = db.p('username', p('postgresql.user'))
    pg_password = db.p('password', p('postgresql.password'))
    pg_database = db.p('name', p('postgresql.database'))
  end.else do
    pg_host = p('postgresql.host')
    pg_port = p('postgresql.port')
    pg_user = p('postgresql.user')
    pg_password = p('postgresql.password')
    pg_database = p('postgresql.database')
  end
-%>
# authentik worker configuration
# Generated by BOSH

log_level: <%= p('log_level') %>

secret_key: "<%= p('authentik.secret_key') %>"

# PostgreSQL configuration
postgresql:
  host: <%= pg_host %>
  port: <%= pg_port %>
  user: <%= pg_user %>
  password: "<%= pg_password %>"
  name: <%= pg_database %>
  sslmode: <%= p('postgresql.sslmode') %>

# Cache configuration
cache:
  timeout: <%= p('cache.timeout') %>
  timeout_flows: <%= p('cache.timeout_flows') %>
  timeout_policies: <%= p('cache.timeout_policies') %>

# Worker configuration
worker:
  concurrency: <%= p('worker.concurrency') %>

# Email configuration
email:
  host: <%= p('email.host') %>
  port: <%= p('email.port') %>
<% if p('email.username') != '' -%>
  username: "<%= p('email.username') %>"
<% end -%>
<% if p('email.password') != '' -%>
  password: "<%= p('email.password') %>"
<% end -%>
  use_tls: <%= p('email.use_tls') %>
  use_ssl: <%= p('email.use_ssl') %>
  from: <%= p('email.from') %>
  timeout: <%= p('email.timeout') %>

disable_startup_analytics: <%= p('disable_startup_analytics') %>

error_reporting:
  enabled: <%= p('error_reporting.enabled') %>

# Storage configuration
storage:
  media:
    backend: <%= p('storage.media.backend') %>
<% if p('storage.media.backend') == 'file' -%>
    file:
      path: /var/vcap/store/authentik/media
<% else -%>
    s3:
      region: <%= p('storage.s3.region') %>
      endpoint: <%= p('storage.s3.endpoint') %>
      access_key: "<%= p('storage.s3.access_key') %>"
      secret_key: "<%= p('storage.s3.secret_key') %>"
      bucket_name: <%= p('storage.s3.bucket_name') %>
      use_ssl: <%= p('storage.s3.use_ssl') %>
<% end -%>

# Paths
paths:
  media: /var/vcap/store/authentik/media
