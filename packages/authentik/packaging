set -e -x

# Set up Python paths
export PATH=/var/vcap/packages/python3/bin:${PATH}
export LD_LIBRARY_PATH=/var/vcap/packages/python3/lib:${LD_LIBRARY_PATH:-}
export PYTHONPATH=${BOSH_INSTALL_TARGET}/lib/python3.12/site-packages

# Create installation directories
mkdir -p ${BOSH_INSTALL_TARGET}/{bin,lib/python3.12/site-packages}

# Install vendored Python dependencies (wheels)
if [ -d authentik/vendor ]; then
  pip install --no-index --find-links=authentik/vendor \
    --prefix=${BOSH_INSTALL_TARGET} \
    --no-deps \
    authentik/vendor/*.whl || true

  # Install any tar.gz packages
  for pkg in authentik/vendor/*.tar.gz; do
    if [ -f "$pkg" ]; then
      pip install --no-index --prefix=${BOSH_INSTALL_TARGET} "$pkg" || true
    fi
  done
fi

# Extract and install authentik
tar xf authentik/authentik-*.tar.gz
pushd authentik-*
  pip install --no-index --find-links=../authentik/vendor \
    --prefix=${BOSH_INSTALL_TARGET} \
    . || pip install --prefix=${BOSH_INSTALL_TARGET} .
popd

# Extract web distribution (compiled frontend assets)
mkdir -p ${BOSH_INSTALL_TARGET}/web
tar xf authentik/web-dist.tar.gz -C ${BOSH_INSTALL_TARGET}/web

# Create wrapper scripts
cat > ${BOSH_INSTALL_TARGET}/bin/ak << 'EOF'
#!/bin/bash
export PATH=/var/vcap/packages/python3/bin:${PATH}
export LD_LIBRARY_PATH=/var/vcap/packages/python3/lib:${LD_LIBRARY_PATH:-}
export PYTHONPATH=/var/vcap/packages/authentik/lib/python3.12/site-packages
exec python -m lifecycle.ak "$@"
EOF
chmod +x ${BOSH_INSTALL_TARGET}/bin/ak

# Create gunicorn wrapper
cat > ${BOSH_INSTALL_TARGET}/bin/gunicorn-ak << 'EOF'
#!/bin/bash
export PATH=/var/vcap/packages/python3/bin:${PATH}
export LD_LIBRARY_PATH=/var/vcap/packages/python3/lib:${LD_LIBRARY_PATH:-}
export PYTHONPATH=/var/vcap/packages/authentik/lib/python3.12/site-packages
exec gunicorn "$@"
EOF
chmod +x ${BOSH_INSTALL_TARGET}/bin/gunicorn-ak
